#include "seeedoled.h"
#include "stm32l4xx_hal.h"
#include <string.h>


extern I2C_HandleTypeDef hi2c1;

/* 当前模式、当前文本行列等状态变量 */
static uint8_t s_addressingMode = SEEEDOLED_PAGE_MODE;
static uint8_t s_textRow = 0;
static uint8_t s_textCol = 0;
//static uint8_t s_textSize = 1;


static const uint8_t BasicFont[][8] = {
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // 32 space
{0x00,0x00,0x5F,0x00,0x00,0x00,0x00,0x00}, // !
{0x00,0x07,0x00,0x07,0x00,0x00,0x00,0x00}, // "
{0x14,0x7F,0x14,0x7F,0x14,0x00,0x00,0x00}, // #
{0x24,0x2A,0x7F,0x2A,0x12,0x00,0x00,0x00}, // $
{0x23,0x13,0x08,0x64,0x62,0x00,0x00,0x00}, // %
{0x36,0x49,0x55,0x22,0x50,0x00,0x00,0x00}, // &
{0x00,0x05,0x03,0x00,0x00,0x00,0x00,0x00}, // '
{0x00,0x1C,0x22,0x41,0x00,0x00,0x00,0x00}, // (
{0x00,0x41,0x22,0x1C,0x00,0x00,0x00,0x00}, // )
{0x14,0x08,0x3E,0x08,0x14,0x00,0x00,0x00}, // *
{0x08,0x08,0x3E,0x08,0x08,0x00,0x00,0x00}, // +
{0x00,0xA0,0x60,0x00,0x00,0x00,0x00,0x00}, // ,
{0x08,0x08,0x08,0x08,0x08,0x00,0x00,0x00}, // -
{0x00,0x60,0x60,0x00,0x00,0x00,0x00,0x00}, // .
{0x20,0x10,0x08,0x04,0x02,0x00,0x00,0x00}, // /
{0x3E,0x51,0x49,0x45,0x3E,0x00,0x00,0x00}, // 0
{0x00,0x42,0x7F,0x40,0x00,0x00,0x00,0x00}, // 1
{0x62,0x51,0x49,0x49,0x46,0x00,0x00,0x00}, // 2
{0x22,0x41,0x49,0x49,0x36,0x00,0x00,0x00}, // 3
{0x18,0x14,0x12,0x7F,0x10,0x00,0x00,0x00}, // 4
{0x27,0x45,0x45,0x45,0x39,0x00,0x00,0x00}, // 5
{0x3C,0x4A,0x49,0x49,0x30,0x00,0x00,0x00}, // 6
{0x01,0x71,0x09,0x05,0x03,0x00,0x00,0x00}, // 7
{0x36,0x49,0x49,0x49,0x36,0x00,0x00,0x00}, // 8
{0x06,0x49,0x49,0x29,0x1E,0x00,0x00,0x00}, // 9
{0x00,0x36,0x36,0x00,0x00,0x00,0x00,0x00}, // :
{0x00,0xAC,0x6C,0x00,0x00,0x00,0x00,0x00}, // ;
{0x08,0x14,0x22,0x41,0x00,0x00,0x00,0x00}, // <
{0x14,0x14,0x14,0x14,0x14,0x00,0x00,0x00}, // =
{0x41,0x22,0x14,0x08,0x00,0x00,0x00,0x00}, // >
{0x02,0x01,0x51,0x09,0x06,0x00,0x00,0x00}, // ?
{0x32,0x49,0x79,0x41,0x3E,0x00,0x00,0x00}, // @
{0x7E,0x11,0x11,0x11,0x7E,0x00,0x00,0x00}, // A
{0x7F,0x49,0x49,0x49,0x36,0x00,0x00,0x00}, // B
{0x3E,0x41,0x41,0x41,0x22,0x00,0x00,0x00}, // C
{0x7F,0x41,0x41,0x22,0x1C,0x00,0x00,0x00}, // D
{0x7F,0x49,0x49,0x49,0x41,0x00,0x00,0x00}, // E
{0x7F,0x09,0x09,0x09,0x01,0x00,0x00,0x00}, // F
{0x3E,0x41,0x49,0x49,0x7A,0x00,0x00,0x00}, // G
{0x7F,0x08,0x08,0x08,0x7F,0x00,0x00,0x00}, // H
{0x00,0x41,0x7F,0x41,0x00,0x00,0x00,0x00}, // I
{0x20,0x40,0x41,0x3F,0x01,0x00,0x00,0x00}, // J
{0x7F,0x08,0x14,0x22,0x41,0x00,0x00,0x00}, // K
{0x7F,0x40,0x40,0x40,0x40,0x00,0x00,0x00}, // L
{0x7F,0x02,0x04,0x02,0x7F,0x00,0x00,0x00}, // M
{0x7F,0x04,0x08,0x10,0x7F,0x00,0x00,0x00}, // N
{0x3E,0x41,0x41,0x41,0x3E,0x00,0x00,0x00}, // O
{0x7F,0x09,0x09,0x09,0x06,0x00,0x00,0x00}, // P
{0x3E,0x41,0x51,0x21,0x5E,0x00,0x00,0x00}, // Q
{0x7F,0x09,0x19,0x29,0x46,0x00,0x00,0x00}, // R
{0x46,0x49,0x49,0x49,0x31,0x00,0x00,0x00}, // S
{0x01,0x01,0x7F,0x01,0x01,0x00,0x00,0x00}, // T
{0x3F,0x40,0x40,0x40,0x3F,0x00,0x00,0x00}, // U
{0x1F,0x20,0x40,0x20,0x1F,0x00,0x00,0x00}, // V
{0x7F,0x20,0x18,0x20,0x7F,0x00,0x00,0x00}, // W
{0x63,0x14,0x08,0x14,0x63,0x00,0x00,0x00}, // X
{0x07,0x08,0x70,0x08,0x07,0x00,0x00,0x00}, // Y
{0x61,0x51,0x49,0x45,0x43,0x00,0x00,0x00}, // Z
{0x00,0x7F,0x41,0x41,0x00,0x00,0x00,0x00}, // [
{0x02,0x04,0x08,0x10,0x20,0x00,0x00,0x00},
{0x00,0x41,0x41,0x7F,0x00,0x00,0x00,0x00}, // ]
{0x04,0x02,0x01,0x02,0x04,0x00,0x00,0x00}, // ^
{0x40,0x40,0x40,0x40,0x40,0x00,0x00,0x00}, // _
{0x00,0x01,0x02,0x00,0x00,0x00,0x00,0x00}, // `
{0x20,0x54,0x54,0x54,0x78,0x00,0x00,0x00}, // a
{0x7F,0x48,0x44,0x44,0x38,0x00,0x00,0x00}, // b
{0x38,0x44,0x44,0x44,0x20,0x00,0x00,0x00}, // c
{0x38,0x44,0x44,0x48,0x7F,0x00,0x00,0x00}, // d
{0x38,0x54,0x54,0x54,0x18,0x00,0x00,0x00}, // e
{0x08,0x7E,0x09,0x01,0x02,0x00,0x00,0x00}, // f
{0x0C,0x52,0x52,0x52,0x3E,0x00,0x00,0x00}, // g
{0x7F,0x08,0x04,0x04,0x78,0x00,0x00,0x00}, // h
{0x00,0x44,0x7D,0x40,0x00,0x00,0x00,0x00}, // i
{0x20,0x40,0x44,0x3D,0x00,0x00,0x00,0x00}, // j
{0x7F,0x10,0x28,0x44,0x00,0x00,0x00,0x00}, // k
{0x00,0x41,0x7F,0x40,0x00,0x00,0x00,0x00}, // l
{0x7C,0x04,0x18,0x04,0x78,0x00,0x00,0x00}, // m
{0x7C,0x08,0x04,0x04,0x78,0x00,0x00,0x00}, // n
{0x38,0x44,0x44,0x44,0x38,0x00,0x00,0x00}, // o
{0x7C,0x14,0x14,0x14,0x08,0x00,0x00,0x00}, // p
{0x08,0x14,0x14,0x18,0x7C,0x00,0x00,0x00}, // q
{0x7C,0x08,0x04,0x04,0x08,0x00,0x00,0x00}, // r
{0x48,0x54,0x54,0x54,0x20,0x00,0x00,0x00}, // s
{0x04,0x3F,0x44,0x40,0x20,0x00,0x00,0x00}, // t
{0x3C,0x40,0x40,0x20,0x7C,0x00,0x00,0x00}, // u
{0x1C,0x20,0x40,0x20,0x1C,0x00,0x00,0x00}, // v
{0x3C,0x40,0x30,0x40,0x3C,0x00,0x00,0x00}, // w
{0x44,0x28,0x10,0x28,0x44,0x00,0x00,0x00}, // x
{0x0C,0x50,0x50,0x50,0x3C,0x00,0x00,0x00}, // y
{0x44,0x64,0x54,0x4C,0x44,0x00,0x00,0x00}, // z
{0x00,0x08,0x36,0x41,0x00,0x00,0x00,0x00}, // {
{0x00,0x00,0x7F,0x00,0x00,0x00,0x00,0x00}, // |
{0x00,0x41,0x36,0x08,0x00,0x00,0x00,0x00}, // }
{0x10,0x08,0x08,0x10,0x08,0x00,0x00,0x00}, // ~
};


/* ================== I2C 发送底层 ================== */

static void oled_i2c_write(uint8_t control, uint8_t data)
{
    uint8_t buf[2];
    buf[0] = control;
    buf[1] = data;
    /* 这里用 hi2c1 */
    HAL_I2C_Master_Transmit(&hi2c1, SEEEDOLED_I2C_ADDR, buf, 2, HAL_MAX_DELAY);
}

/* 对外函数实现  */

void SeeedOLED_SendCommand(uint8_t cmd)
{
    oled_i2c_write(SEEEDOLED_CMD_MODE, cmd);
}

void SeeedOLED_SendData(uint8_t data)
{
    oled_i2c_write(SEEEDOLED_DATA_MODE, data);
}

void SeeedOLED_SetBrightness(uint8_t brightness)
{
    SeeedOLED_SendCommand(SEEEDOLED_SET_BRIGHTNESS);
    SeeedOLED_SendCommand(brightness);
}

void SeeedOLED_SetNormalDisplay(void)
{
    SeeedOLED_SendCommand(SEEEDOLED_NORMAL_DISPLAY);
}

void SeeedOLED_SetInverseDisplay(void)
{
    SeeedOLED_SendCommand(SEEEDOLED_INVERSE_DISPLAY);
}

void SeeedOLED_SetHorizontalMode(void)
{
    s_addressingMode = SEEEDOLED_HORIZONTAL_MODE;
    SeeedOLED_SendCommand(0x20);
    SeeedOLED_SendCommand(0x00);
}

void SeeedOLED_SetPageMode(void)
{
    s_addressingMode = SEEEDOLED_PAGE_MODE;
    SeeedOLED_SendCommand(0x20);
    SeeedOLED_SendCommand(0x02);
}

void SeeedOLED_SetTextXY(uint8_t row, uint8_t col)
{
    s_textRow = row;
    s_textCol = col;
    /* set page address */
    SeeedOLED_SendCommand(0xB0 + row);
    /* set column lower address */
    SeeedOLED_SendCommand(0x00 + (8 * col & 0x0F));
    /* set column higher address */
    SeeedOLED_SendCommand(0x10 + ((8 * col >> 4) & 0x0F));
}

void SeeedOLED_ClearDisplay(void)
{
    uint8_t i, j;
    SeeedOLED_SendCommand(SEEEDOLED_DISPLAY_OFF);
    for (j = 0; j < 8; j++) {
        SeeedOLED_SetTextXY(j, 0);
        for (i = 0; i < 16; i++) {
            SeeedOLED_PutChar(' ');
        }
    }
    SeeedOLED_SendCommand(SEEEDOLED_DISPLAY_ON);
    SeeedOLED_SetTextXY(0, 0);
}

void SeeedOLED_PutChar(uint8_t c)
{
    if (c < 32 || c > 127) {
        c = ' ';
    }
    for (uint8_t i = 0; i < 8; i++) {
        uint8_t b = BasicFont[c - 32][i];
        SeeedOLED_SendData(b);
    }
    s_textCol++;
}

void SeeedOLED_PutString(const char *str)
{
    while (*str) {
        SeeedOLED_PutChar((uint8_t)*str++);
    }
}

uint8_t SeeedOLED_PutNumber(long n)
{
    char buf[16];
    int  idx = 0;
    int  neg = 0;
    if (n == 0) {
        SeeedOLED_PutChar('0');
        return 1;
    }
    if (n < 0) {
        neg = 1;
        n = -n;
    }
    while (n > 0 && idx < (int)sizeof(buf)) {
        buf[idx++] = '0' + (n % 10);
        n /= 10;
    }
    if (neg) {
        SeeedOLED_PutChar('-');
    }
    for (int i = idx - 1; i >= 0; i--) {
        SeeedOLED_PutChar(buf[i]);
    }
    return (uint8_t)(idx + neg);
}

uint8_t SeeedOLED_PutFloat(float f, uint8_t decimal)
{
    if (f < 0) {
        SeeedOLED_PutChar('-');
        f = -f;
    }
    long intPart = (long)f;
    uint8_t count = 0;
    count += SeeedOLED_PutNumber(intPart);
    if (decimal == 0) return count;
    SeeedOLED_PutChar('.');
    count++;
    float frac = f - (float)intPart;
    for (uint8_t i = 0; i < decimal; i++) {
        frac *= 10.0f;
        int d = (int)frac;
        SeeedOLED_PutChar('0' + d);
        frac -= d;
        count++;
    }
    return count;
}

void SeeedOLED_Init(void)
{
    HAL_Delay(50);
    SeeedOLED_SendCommand(SEEEDOLED_DISPLAY_OFF);
    HAL_Delay(5);
    SeeedOLED_SendCommand(SEEEDOLED_DISPLAY_ON);
    HAL_Delay(5);
    SeeedOLED_SetNormalDisplay();
    SeeedOLED_SetPageMode();
    SeeedOLED_ClearDisplay();
}
